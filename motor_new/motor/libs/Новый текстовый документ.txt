#include "MotorLib.h"




uint8_t  __MoveForwardJoy (uint16_t speed){
	
	 HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_RESET); HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_SET);
	
	_MotorSpeedEnterJoy(_MotorPwmPeriod-speed/((_JoystickUnderZero-_JoystickMin)/_MotorPwmPeriod));

	return 0;
}

uint8_t __MoveBackwardJoy  (uint16_t speed){
		
	HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_RESET);HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_SET);
	_MotorSpeedEnterJoy(_MotorPwmPeriod-speed/((_JoystickMax-_JoystickUpToZero)/_MotorPwmPeriod));
		//_MotorSpeedEnterJoy(_MotorPwmPeriod-speed/((_JoystickUnderZero-_JoystickMin)/_MotorPwmPeriod));
		return 0;
}

uint8_t __MoveZero  (){
		
	_MotorSpeedReg4=0;
		return 0;
}

uint8_t _MotorSpeedEnterJoy  (uint16_t speed ){
		printf("speed=%d \r\n",speed);
	_MotorSpeedReg4=speed;
 HAL_TIM_PWM_Start(&htim4, TIM_CHANNEL_4);
		return 0;
}


void MoveByJoystick (uint16_t testts){

     HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_RESET); HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_RESET);
		 testts<_JoystickUnderZero ? __MoveForwardJoy(testts) :  (testts>_JoystickUpToZero ? __MoveBackwardJoy(testts) : __MoveZero());
   
}


void MoveAndTurn(uint16_t speedX,int16_t speedY){

	uint16_t temp1,temp2;
	
	 //speedX<_JoystickUnderZero ? __MoveForwardJoy(speedX) :  (speedX>_JoystickUpToZero ? __MoveBackwardJoy(speedX) : __MoveZero());

	
	if(speedY<_JoystickUnderZero){
		printf("back\r\n");

		
			if(speedX<_JoystickUnderZero){
				HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_RESET);HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_SET);
				
				temp1=_MotorPwmPeriod-speedY/_YaxisUnderZero;
				if(temp1>100 && temp1<1000 ) temp1=100;
				if(temp1>1000)  temp1=0;
				_MotorSpeedReg4=temp1;
				
				temp2=_MotorPwmPeriod-(speedY+speedX)/_YaxisUnderZero ;
				if(temp2>100 && temp2<1000 ) temp2=100;
				if(temp2>1000)  temp2=0;
				_MotorSpeedReg3=temp2;
				
				//printf("speedX=%d speedY=%d \r\n",speedX,speedY);
				printf("UnderZero r=%d lt=%d \r\n",_MotorSpeedReg4,_MotorSpeedReg3);
	}
	else if (speedX>_JoystickUpToZero){
					HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_RESET);HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_SET);
		
				temp1=_MotorPwmPeriod-speedY/_YaxisUnderZero +(_JoystickUpToZero+speedX)/_YaxisUpZero;;
				if(temp1>100 && temp1<1000 ) temp1=100;
				if(temp1>1000)  temp1=0;
				_MotorSpeedReg4=temp1;
				
				temp2=_MotorPwmPeriod-speedY/_YaxisUnderZero ;
				if(temp2>100 && temp2<1000 ) temp2=100;
				if(temp2>1000)  temp2=0;
				_MotorSpeedReg3=temp2;
				
		

	//	printf("speedX=%d speedY=%d \r\n",speedX,speedY);
					//printf("UpToZero r=%d l=%d \r\n",_MotorPwmPeriod-(speedY+_JoystickMax-speedX)/_YaxisUnderZero,_MotorPwmPeriod-speedY/_YaxisUnderZero );
		printf("UpToZero r=%d lt=%d \r\n",_MotorSpeedReg4,_MotorSpeedReg3);
	}
	else {
					HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_RESET);HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_SET);
		
		
				temp1=_MotorPwmPeriod-speedY/((_JoystickUnderZero-_JoystickMin)/_MotorPwmPeriod);
				if(temp1>100 && temp1<1000 ) temp1=100;
				if(temp1>1000)  temp1=0;
				_MotorSpeedReg4=temp1;
				
				temp2=_MotorPwmPeriod-speedY/((_JoystickUnderZero-_JoystickMin)/_MotorPwmPeriod);
				if(temp2>100 && temp2<1000 ) temp2=100;
				if(temp2>1000)  temp2=0;
				_MotorSpeedReg3=temp2;
		

	//	printf("speedX=%d speedY=%d \r\n",speedX,speedY); 
    //       printf("right=%d left=%d \r\n",_MotorSpeedReg4,_MotorSpeedReg3 );
	}
	
			}
			else if(!(speedY<_JoystickUnderZero)&& !(speedY>_JoystickUpToZero)){			
			HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_RESET);HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_RESET);
			_MotorSpeedReg4=0;
			_MotorSpeedReg3=0;
			
			}
	
	else if(speedY>_JoystickUpToZero){ 
		printf("forward \r\n");

					if(speedX<_JoystickUnderZero){
				HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_RESET); HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_SET);
						
				temp1=(speedY-_JoystickUpToZero)/_YaxisUpZero - speedX/(_JoystickUnderZero/100);
				if(temp1>100 && temp1<1000 ) temp1=100;
				if(temp1>1000)  temp1=0;
				_MotorSpeedReg4=temp1;
				
				temp2=(speedY-_JoystickUpToZero)/_YaxisUpZero + speedX/(_JoystickUnderZero/100);
				if(temp2>100 && temp2<1000 ) temp2=100;
				if(temp2>1000)  temp2=0;
				_MotorSpeedReg3=temp2;

				printf("speedX=%d speedY=%d \r\n",speedX,speedY);
						//printf("UnderZero r=%d lt=%d \r\n",_MotorPwmPeriod-speedY/_YaxisUpZero,_MotorPwmPeriod-(speedY+speedX)/_YaxisUpZero );
							printf("UnderZero r=%d lt=%d \r\n",_MotorSpeedReg4,_MotorSpeedReg3);
	}
	else if (speedX>_JoystickUpToZero){
					HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_RESET); HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_SET);
		
						temp1=(speedY-_JoystickUpToZero)/_YaxisUpZero + speedX/_YaxisUpZero;
				if(temp1>100 && temp1<1000 ) temp1=100;
				if(temp1>1000)  temp1=0;
				_MotorSpeedReg4=temp1;
				
				temp2=(speedY-_JoystickUpToZero)/_YaxisUpZero - speedX/_YaxisUpZero; 
				if(temp2>100 && temp2<1000 ) temp2=100;
				if(temp2>1000)  temp2=0;
				_MotorSpeedReg3=temp2;
		

		printf("speedX=%d speedY=%d \r\n",speedX,speedY);
		//			printf("UpToZero r=%d l=%d \r\n",_MotorPwmPeriod-(speedY+_JoystickMax-speedX)/_YaxisUpZero,_MotorPwmPeriod-speedY/_YaxisUpZero );
			printf("UpToZero r=%d lt=%d \r\n",_MotorSpeedReg4,_MotorSpeedReg3);
	}
	else {
				HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_RESET); HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_SET);
		
		
								temp1=_MotorPwmPeriod-speedY/_YaxisUpZero;
				if(temp1>100 && temp1<1000 ) temp1=100;
				if(temp1>1000)  temp1=0;
				_MotorSpeedReg4=temp1;
				
				temp2=_MotorPwmPeriod-speedY/_YaxisUpZero ;
				if(temp2>100 && temp2<1000 ) temp2=100;
				if(temp2>1000)  temp2=0;
				_MotorSpeedReg3=temp2;
		
	//	printf("speedX=%d speedY=%d \r\n",speedX,speedY); 
   //        printf("right=%d left=%d \r\n",_MotorSpeedReg4,_MotorSpeedReg3 );
	}
		
		
	}
				else if(!(speedY<_JoystickUnderZero)&& !(speedY>_JoystickUpToZero)){			
			HAL_GPIO_WritePin(GPIOA,GPIO_PIN_12,GPIO_PIN_RESET);HAL_GPIO_WritePin(GPIOA,GPIO_PIN_11,GPIO_PIN_RESET);
			_MotorSpeedReg4=0;
			_MotorSpeedReg3=0;
			
			}